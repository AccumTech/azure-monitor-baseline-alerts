- name: HybridVMHighDataDiskReadLatencyAlert
  description: Log Alert for Hybrid Virtual Machine dataDiskReadLatency
  type: Log
  verified: false
  visible: true
  tags:
  - alz
  properties:
    severity: 2
    operator: GreaterThan
    timeAggregation: Count
    windowSize: PT15M
    evaluationFrequency: PT5M
    threshold: 30
    metricMeasureColumn: AggregatedValue
    resouceIdColumn: _ResourceId
    dimensions:
    - name: Computer
      operator: Include
      values:
      - '*'
    - name: Disk
      operator: Include
      values:
      - '*'
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: 'InsightsMetrics
      | where _ResourceId has "Microsoft.HybridCompute/machines"
      | where Origin == "vm.azm.ms"
      | where Namespace == "LogicalDisk" and Name == "ReadLatencyMs"
      | extend Disk=tostring(todynamic(Tags)["vm.azm.ms/mountId"])
      | where Disk !in ("C:", "/")
      | summarize AggregatedValue = avg(Val) by bin(TimeGenerated, 15m), Computer, _ResourceId, Disk'
    autoMitigate: true
    autoResolve: true
    autoResolveTime: 0:10:00
  references:
  - name: 'Monitor virtual machines with Azure Monitor: Alerts'
    url: https://learn.microsoft.com/en-us/azure/azure-monitor/vm/monitor-virtual-machine-alerts#common-alert-rules
  deployments:
  - name: Deploy Hybrid VM Data Disk Read Latency Alert
    template: Deploy-Hybrid-VM-DataDiskReadLatency-Alert.json
    type: Policy
    tags:
    - alz
    properties:
      scope: Subscription
      multiResource: false
  guid: 6aff7331-001f-4ee6-b5d2-1fc43b18b7de
