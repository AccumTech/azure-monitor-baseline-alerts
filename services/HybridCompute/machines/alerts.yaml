- name: Hybrid VM Data Disk Read Latency Alert
  description: Log Alert for Hybrid Virtual Machine Data Disk Read Latency
  type: Log
  verified: false
  visible: true
  tags:
  - alz
  properties:
    severity: 2
    operator: GreaterThan
    timeAggregation: Average
    windowSize: PT15M
    evaluationFrequency: PT5M
    threshold: 25
    metricMeasureColumn: AggregatedValue
    resouceIdColumn: _ResourceId
    dimensions:
    - name: Computer
      operator: Include
      values:
      - '*'
    - name: Disk
      operator: Include
      values:
      - '*'
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: 'InsightsMetrics
      | where _ResourceId has "Microsoft.HybridCompute/machines"
      | where Origin == "vm.azm.ms"
      | where Namespace == "LogicalDisk" and Name == "ReadLatencyMs"
      | extend Disk=tostring(todynamic(Tags)["vm.azm.ms/mountId"])
      | where Disk !in ("C:", "/")
      | summarize AggregatedValue = avg(Val) by bin(TimeGenerated, 15m), Computer, _ResourceId, Disk'
    autoMitigate: true
    autoResolve: true
    autoResolveTime: 0:10:00
  references:
  - name: 'Monitor virtual machines with Azure Monitor: Alerts'
    url: https://learn.microsoft.com/en-us/azure/azure-monitor/vm/monitor-virtual-machine-alerts#common-alert-rules
  deployments:
  - name: Deploy Hybrid VM Data Disk Read Latency Alert
    template: Deploy-Hybrid-VM-DataDiskReadLatency-Alert.json
    type: Policy
    tags:
    - alz
    properties:
      scope: Subscription
      multiResource: false
  guid: 6aff7331-001f-4ee6-b5d2-1fc43b18b7de
- name: Hybrid VM Data Disk Free Space Percentage Alert
  description: Log Alert for Hybrid VM Data Disk Free Space Percentage
  type: Log
  verified: false
  visible: true
  tags:
  - alz
  properties:
    severity: 2
    operator: LessThan
    timeAggregation: Average
    windowSize: PT15M
    evaluationFrequency: PT5M
    threshold: 10
    metricMeasureColumn: AggregatedValue
    resouceIdColumn: _ResourceId
    dimensions:
    - name: Computer
      operator: Include
      values:
      - '*'
    - name: Disk
      operator: Include
      values:
      - '*'
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: 'InsightsMetrics
      | where _ResourceId has "Microsoft.HybridCompute/machines"
      | where Origin == "vm.azm.ms"
      | where Namespace == "LogicalDisk"and Name == "FreeSpacePercentage"
      | extend Disk=tostring(todynamic(Tags)["vm.azm.ms/mountId"])
      | where Disk !in ("C:","/")
      | summarize AggregatedValue = avg(Val) by bin(TimeGenerated,15m), Computer,_ResourceId, Disk'
    autoMitigate: true
    autoResolve: true
    autoResolveTime: 0:10:00
  references:
  - name: 'Monitor virtual machines with Azure Monitor: Alerts'
    url: https://learn.microsoft.com/en-us/azure/azure-monitor/vm/monitor-virtual-machine-alerts#common-alert-rules
  deployments:
  - name: Deploy Hybrid VM Data Disk Free Space Percentage Alert
    template: Deploy-Hybrid-VM-DataDiskSpace-Alert.json
    type: Policy
    tags:
    - alz
    properties:
      scope: Subscription
      multiResource: false
  guid: 2030d931-6431-4134-9a03-106ebb83cb2d
- name: Hybrid VM Data Disk Write Latency Alert
  description: Log Alert for Hybrid Virtual Machine Data Disk Write Latency (ms)
  type: Log
  verified: false
  visible: true
  tags:
  - alz
  properties:
    severity: 2
    operator: GreaterThan
    timeAggregation: Average
    windowSize: PT15M
    evaluationFrequency: PT5M
    threshold: 25
    metricMeasureColumn: AggregatedValue
    resouceIdColumn: _ResourceId
    dimensions:
    - name: Computer
      operator: Include
      values:
      - '*'
    - name: Disk
      operator: Include
      values:
      - '*'
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: 'InsightsMetrics
      | where _ResourceId has "Microsoft.HybridCompute/machines"
      | where Origin == "vm.azm.ms"
      | where Namespace == "LogicalDisk" and Name == "WriteLatencyMs"
      | extend Disk=tostring(todynamic(Tags)["vm.azm.ms/mountId"])
      | where Disk !in ("C:","/")
      | summarize AggregatedValue = avg(Val) by bin(TimeGenerated,15m), Computer, _ResourceId, Disk'
    autoMitigate: true
    autoResolve: true
    autoResolveTime: 0:10:00
  references:
  - name: 'Monitor hybrid virtual machines with Azure Monitor: Alerts'
    url: https://learn.microsoft.com/en-us/azure/azure-monitor/vm/monitor-virtual-machine-alerts#common-alert-rules
  deployments:
  - name: Deploy Hybrid VM Data Disk Write Latency Alert
    template: Deploy-Hybrid-VM-DataDiskWriteLatency-Alert.json
    type: Policy
    tags:
    - alz
    properties:
      scope: Subscription
      multiResource: false
  guid: c4226730-ae59-4607-bddc-03b91dad1c4b
- name: Hybrid VM Disconnected Alert
  description: Log Alert for Hybrid Virtual Machine Disconnected
  type: Log
  verified: false
  visible: true
  properties:
    severity: 1
    operator: GreaterThan
    timeAggregation: Average
    windowSize: P1D
    evaluationFrequency: PT10M
    threshold: 10
    metricMeasureColumn: AggregatedValue
    resouceIdColumn: _ResourceId
    dimensions:
    - name: Computer
      operator: Include
      values:
      - '*'
    - name: Disk
      operator: Include
      values:
      - '*'
    failingPeriods:
      numberOfEvaluationPeriods: 1
      minFailingPeriodsToAlert: 1
    query: 'resources
      | where type == "microsoft.hybridcompute/machines"
      | where tostring(properties.status) == "Disconnected"
      | extend lastContactedDate = todatetime(properties.lastStatusChange)
      | where lastContactedDate <= ago(totimespan(10m))
      | extend status = tostring(properties.status)
      | project id, Computer=name, status, lastContactedDate'
    autoMitigate: true
    autoResolve: true
    autoResolveTime: 0:10:00
  references:
  - name: 'Monitor virtual machines with Azure Monitor: Alerts'
    url: https://learn.microsoft.com/en-us/azure/azure-monitor/vm/monitor-virtual-machine-alerts#common-alert-rules
  deployments:
  - name: Deploy Hybrid VM Disconnected Alert
    template: Deploy-Hybrid-VM-Disconnected-Alert.json
    type: Policy
    tags:
    - alz
    properties:
      scope: Subscription
      multiResource: false
  guid: 34da0d5b-5ccb-474e-9811-3d5fdb81053c
